rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========== FUNCIONES HELPER ==========

    // Función helper: usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // Función helper: es usuario de Prestamype
    function isPrestamypeUser() {
      return isAuthenticated() &&
             request.auth.token.email != null &&
             request.auth.token.email.matches('.*@prestamype.com$');
    }

    // Función helper: es usuario anónimo (para demo/pruebas)
    function isAnonymousUser() {
      return isAuthenticated() &&
             request.auth.token.firebase.sign_in_provider == 'anonymous';
    }

    // Función helper: usuario autorizado (Prestamype O anónimo)
    function isAuthorizedUser() {
      return isPrestamypeUser() || isAnonymousUser();
    }

    // Función helper: es el creador del documento
    function isOwner(resource) {
      return isPrestamypeUser() &&
             resource.data.presentador_email == request.auth.token.email;
    }

    // Función helper: es el facilitador de votaciones
    function isFacilitator() {
      return isPrestamypeUser() &&
             request.auth.token.email == 'jantonio@prestamype.com';
    }

    // ========== CRITICS_SESSIONS ==========

    match /critics_sessions/{docId} {
      // Usuarios autorizados pueden leer:
      // 1. DC activos (para todos)
      // 2. Sus propios DC (para historial personal)
      allow read: if isAuthorizedUser() &&
                     (resource.data.estado == 'activo' || isOwner(resource));

      // Solo usuarios Prestamype pueden crear DC
      allow create: if isPrestamypeUser() &&
                       request.resource.data.presentador_email == request.auth.token.email;

      // Puede actualizar si:
      // 1. Es el dueño (puede editar sus propias sesiones, incluido mover fecha o cambiar votingStatus)
      // 2. Es facilitador Y solo modifica presentationOrder o voteResult
      allow update: if isOwner(resource) ||
                       (isFacilitator() && onlyFacilitatorFields()) ||
                       (isPrestamypeUser() && isOwnerVotingAction(resource));

      // Solo el creador puede eliminar (cambiar estado)
      allow delete: if isOwner(resource);

      function onlyFacilitatorFields() {
        let changedKeys = request.resource.data.diff(resource.data)
                           .affectedKeys();
        return changedKeys.hasOnly(['presentationOrder', 'updatedAt', 'voteResult']);
      }

      // Permite al presentador cambiar votingStatus y fecha desde la sala de votación
      function isOwnerVotingAction(resource) {
        let changedKeys = request.resource.data.diff(resource.data)
                           .affectedKeys();
        return resource.data.presentador_email == request.auth.token.email &&
               changedKeys.hasOnly(['votingStatus', 'fecha_dc', 'movidaDesde', 'movidaAt', 'estado', 'deleted_at']);
      }
    }

    // ========== LIVE_SESSIONS (Votaciones en vivo) ==========

    match /live_sessions/{sessionCode} {
      // Cualquier usuario autorizado puede leer sesiones
      allow read: if isAuthorizedUser();

      // Facilitador o sistema (cron job) puede crear sesiones
      // El cron job se autentica como facilitador o usa autoCreated flag
      allow create: if isFacilitator() || isPrestamypeUser();

      // Facilitador puede actualizar completamente (incluye cancelar votaciones)
      // Presentadores pueden iniciar votación de su propia sesión (currentVotingCriticId)
      // Usuarios pueden actualizar su conexión y votos
      allow update: if isFacilitator() ||
                       (isPrestamypeUser() && isValidUserUpdate()) ||
                       (isPrestamypeUser() && isValidPresenterAction());

      // Solo facilitador puede eliminar sesiones
      allow delete: if isFacilitator();

      function isValidUserUpdate() {
        let affectedKeys = request.resource.data.diff(resource.data)
                            .affectedKeys();
        return affectedKeys.hasOnly(['connectedUsers', 'votes']);
      }

      // Permite al presentador iniciar/completar votación de su propia sesión
      function isValidPresenterAction() {
        let affectedKeys = request.resource.data.diff(resource.data)
                            .affectedKeys();
        return affectedKeys.hasOnly(['currentVotingCriticId', 'status', 'votes']);
      }
    }

    // ========== USER_SETTINGS ==========

    match /user_settings/{email} {
      // Usuarios Prestamype pueden leer/escribir su propia config
      // Usuarios anónimos pueden leer cualquier config (para demo)
      allow read: if isPrestamypeUser() && email == request.auth.token.email ||
                     isAnonymousUser();
      allow write: if isPrestamypeUser() && email == request.auth.token.email;
    }

    // ========== FIGMA_CACHE ==========

    // Cache de Happy Paths para evitar llamadas excesivas a Figma API
    match /figma_cache/{fileKey} {
      // Todos los usuarios autorizados pueden leer y crear/actualizar el caché
      allow read, write: if isAuthorizedUser();
    }
  }
}
